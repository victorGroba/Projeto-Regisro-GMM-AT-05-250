<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Temperatura - Carta Controle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 11px;
            margin: 10px;
            color: #333;
        }

        .container {
            max-width: 1200px; /* Aumentei um pouco para caber a tabela grande */
            margin: auto;
            padding: 10px;
        }

        /* Cabe√ßalho e T√≠tulo */
        .title-header {
            display: flex;
            border: 1px solid #000;
            margin-bottom: 10px;
        }

        .title-header>div {
            border-right: 1px solid #000;
            flex: 1;
            text-align: center;
            padding: 5px;
        }

        .title-header>div:last-child {
            border-right: none;
        }

        .title-header h3,
        .title-header p {
            margin: 0;
            font-size: 10px;
        }

        .header,
        .footer,
        .side-info {
            font-size: 11px;
        }

        /* Tabela Carta Controle */
        table.tabela-modelo {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px; /* Fonte menor para caber tudo */
        }

        table.tabela-modelo th,
        table.tabela-modelo td {
            border: 1px solid black;
            padding: 4px;
            text-align: center;
        }

        table.tabela-modelo th {
            background-color: #dceeff; /* Azulzinho claro para destaque */
            font-weight: bold;
            vertical-align: middle;
        }

        /* Cores das colunas estat√≠sticas para facilitar leitura */
        .col-nc { background-color: #ffe6e6; } /* Vermelho claro */
        .col-na { background-color: #fff5cc; } /* Amarelo claro */
        .col-s  { background-color: #e6fffa; } /* Verde claro */

        .legend-list {
            list-style: none;
            padding-left: 0;
            font-size: 10px;
        }

        .main-content {
            display: flex;
            flex-direction: column; /* Mudei para coluna para o gr√°fico ficar em cima */
            gap: 20px;
        }

        .chart-container {
            width: 100%;
            height: 350px;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 15px;
            background: #fff;
        }

        .data-section {
            display: flex;
            gap: 20px;
        }

        .table-wrapper {
            flex: 1;
            overflow-x: auto;
        }

        .info-side {
            width: 220px;
            flex-shrink: 0;
            border-left: 1px solid #ddd;
            padding-left: 15px;
        }

        .bloco-impressao {
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            background: white;
        }

        .footer {
            margin-top: 10px;
            border-top: 1px solid #000;
            padding-top: 5px;
        }

        @media print {
            .no-print {
                display: none !important;
            }
            .container {
                max-width: 100%;
                border: none;
                box-shadow: none;
                padding: 0;
            }
            .chart-container {
                height: 300px; /* Ajuste para impress√£o */
            }
            body {
                margin: 0;
                font-size: 10px;
            }
            /* For√ßar impress√£o de cores de fundo */
            table th, .col-nc, .col-na, .col-s {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>

<body>

    <ul class="nav nav-tabs no-print mb-3" id="mesTabs" role="tablist">
        {% for mes_ano, dados in historico_mensal.items() %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if loop.first %}active{% endif %}" id="tab-{{ loop.index }}" data-bs-toggle="tab"
                data-bs-target="#mes-{{ loop.index }}" type="button" role="tab" onclick="carregarGrafico('{{ loop.index }}', '{{ termometro.id }}', '{{ mes_ano|replace('/', '-') }}')">
                {{ mes_ano }}
            </button>
        </li>
        {% endfor %}
    </ul>

    <div class="tab-content">
        {% for mes_ano, dados in historico_mensal.items() %}
        {% set media = dados.media %}
        {% set desvio = dados.desvio %}
        {% set lista = dados.lista %}

        <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="mes-{{ loop.index }}" role="tabpanel">
            <div class="container bloco-impressao">

                <div class="no-print mb-2 d-flex justify-content-between">
                    <div>
                        <a href="{{ url_for('main.index') }}" class="btn btn-secondary btn-sm">‚Üê Voltar</a>
                    </div>
                    <div>
                        <button onclick="window.print()" class="btn btn-success btn-sm">üñ® Imprimir Carta Controle</button>
                    </div>
                </div>

                <div class="header d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center">
                        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo"
                            style="height:40px;margin-right:10px;">
                    </div>
                    <div style="color:#0047AB; text-align: right; font-weight:bold;">
                        SISTEMA DA GEST√ÉO DE QUALIDADE
                    </div>
                </div>

                <div class="title-header">
                    <div>
                        <h3 style="text-align: left;">T√≠tulo</h3>
                        <p style="color: #0047AB; font-weight: bold;">CARTA CONTROLE DE TEMPERATURA</p>
                    </div>
                    <div>
                        <h3 style="text-align: left;">Identifica√ß√£o</h3>
                        <p style="color: #0047AB;">MM-05-AT-483</p> </div>
                    <div>
                        <h3 style="text-align: left;">Revis√£o</h3>
                        <p style="color: #0047AB;">03</p>
                    </div>
                    <div>
                        <h3 style="text-align: left;">P√°g</h3>
                        <p style="color: #0047AB;">1/1</p>
                    </div>
                </div>

                <div class="main-content">
                    
                    <div class="chart-container">
                        <canvas id="chart-{{ loop.index }}"></canvas>
                        <input type="hidden" id="loaded-{{ loop.index }}" value="false">
                    </div>

                    <div class="data-section">
                        
                        <div class="table-wrapper">
                            <h5 style="color: #0047AB; font-size: 12px; margin-bottom: 5px;">
                                Hist√≥rico: {{ mes_ano }} | M√©dia: {{ "%.2f"|format(media) }} | Desvio Padr√£o: {{ "%.4f"|format(desvio) }}
                            </h5>
                            
                            <table class="tabela-modelo">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Data</th>
                                        <th>Resultado (¬∞C)</th>
                                        <th>M√©dia</th>
                                        <th>Desvio Padr√£o</th>
                                        
                                        <th class="col-nc">NC Inf<br>(-3S)</th>
                                        <th class="col-na">NA Inf<br>(-2S)</th>
                                        <th class="col-s">(-1S)</th>
                                        
                                        <th class="col-s">(+1S)</th>
                                        <th class="col-na">NA Sup<br>(+2S)</th>
                                        <th class="col-nc">NC Sup<br>(+3S)</th>
                                        
                                        <th>A√ß√£o Corretiva / Obs</th>
                                        <th>Analista</th>
                                        
                                        {% if session.get('is_admin') %}
                                        <th class="no-print">A√ß√µes</th>
                                        {% endif %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for v in lista %}
                                    <tr>
                                        <td>{{ loop.index }}</td>
                                        <td>{{ v.get_data_hora_sp().strftime('%d/%m/%Y') }}</td>
                                        
                                        <td style="font-weight: bold;">
                                            {{ v.temperatura_atual }}
                                        </td>

                                        <td>{{ "%.2f"|format(media) }}</td>
                                        <td>{{ "%.3f"|format(desvio) }}</td>

                                        <td class="col-nc">{{ "%.2f"|format(media - 3*desvio) }}</td>
                                        <td class="col-na">{{ "%.2f"|format(media - 2*desvio) }}</td>
                                        <td class="col-s">{{ "%.2f"|format(media - 1*desvio) }}</td>
                                        
                                        <td class="col-s">{{ "%.2f"|format(media + 1*desvio) }}</td>
                                        <td class="col-na">{{ "%.2f"|format(media + 2*desvio) }}</td>
                                        <td class="col-nc">{{ "%.2f"|format(media + 3*desvio) }}</td>

                                        <td style="text-align: left; font-size: 9px;">{{ v.observacao or '' }}</td>
                                        
                                        <td>{{ v.responsavel }}</td>

                                        {% if session.get('is_admin') %}
                                        <td class="no-print">
                                            <form method="POST" action="{{ url_for('main.excluir_verificacao', id=v.id) }}" style="display:inline;">
                                                <button type="submit" class="btn btn-danger btn-sm" style="padding: 0px 4px; font-size: 9px;" onclick="return confirm('Excluir?')">X</button>
                                            </form>
                                        </td>
                                        {% endif %}
                                    </tr>
                                    {% endfor %}
                                    
                                    {% if lista|length < 10 %}
                                        {% for i in range(10 - lista|length) %}
                                        <tr>
                                            <td>-</td><td></td><td></td><td></td><td></td>
                                            <td class="col-nc"></td><td class="col-na"></td><td class="col-s"></td>
                                            <td class="col-s"></td><td class="col-na"></td><td class="col-nc"></td>
                                            <td></td><td></td>
                                            {% if session.get('is_admin') %}<td class="no-print"></td>{% endif %}
                                        </tr>
                                        {% endfor %}
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>

                        <div class="info-side">
                            <div class="mb-2"><strong>Setor:</strong> {{ termometro.setor }}</div>
                            <div class="mb-2"><strong>Equipamento:</strong><br> {{ termometro.equipamento }}</div>
                            <div class="mb-2"><strong>Especifica√ß√£o:</strong><br> {{ termometro.especificacao }}</div>
                            <hr>
                            <div class="mb-2"><strong>Term√¥metro:</strong> {{ termometro.identificacao }}</div>
                            <div class="mb-2"><strong>Padr√£o:</strong> {{ termometro.padrao_identificacao }}</div>
                            <hr>
                            <div class="legend-section">
                                <div class="legend-title"><strong>Legenda do Gr√°fico:</strong></div>
                                <ul class="legend-list">
                                    <li><span style="color:black">‚óè</span> Resultado</li>
                                    <li><span style="color:orange">---</span> M√©dia</li>
                                    <li><span style="color:red">‚Äï</span> Limite Controle (3S)</li>
                                    <li><span style="color:#FFD700">‚Äï</span> Limite Alerta (2S)</li>
                                    <li><span style="color:green">‚Äï</span> 1 Sigma (1S)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="footer">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>An√°lise Cr√≠tica:</strong><br>
                            (&nbsp;&nbsp;) Aprovado<br>
                            (&nbsp;&nbsp;) Reprovado
                        </div>
                        <div>
                            <strong>Visto Gestor / Data:</strong><br>
                            __________________________  ___/___/___
                        </div>
                    </div>
                    <div class="small mt-2" style="font-style: italic;">
                        * Nota: O desvio padr√£o √© calculado com base nas amostras do m√™s corrente.
                    </div>
                </div>

            </div>
        </div>
        {% endfor %}
    </div>

    <script>
        // Fun√ß√£o chamada ao clicar na aba ou ao carregar a p√°gina
        function carregarGrafico(index, termoId, mesAno) {
            const canvasId = `chart-${index}`;
            const loadedId = `loaded-${index}`;
            const isLoaded = document.getElementById(loadedId).value;

            // Se j√° carregou, n√£o faz nada
            if (isLoaded === "true") return;

            // Chama a rota do backend que devolve o JSON pronto para o Chart.js
            // Obs: A rota no routes.py deve ser algo como /dados_carta_controle/<id>/<mes_ano>
            // O replace de barras por tra√ßos no HTML ajuda a passar na URL
            fetch(`/dados_carta_controle/${termoId}/${mesAno}`)
                .then(response => response.json())
                .then(dados => {
                    const ctx = document.getElementById(canvasId).getContext('2d');
                    
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dados.labels,
                            datasets: dados.datasets.map(ds => ({
                                ...ds,
                                fill: false,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            }))
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index',
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { boxWidth: 12, font: { size: 10 } }
                                },
                                title: {
                                    display: true,
                                    text: `Carta Controle - ${mesAno}`
                                }
                            },
                            scales: {
                                y: {
                                    title: { display: true, text: 'Temperatura (¬∞C)' },
                                    ticks: { stepSize: 0.5 } // Ajuda na visualiza√ß√£o
                                }
                            }
                        }
                    });

                    // Marca como carregado para n√£o chamar a API de novo
                    document.getElementById(loadedId).value = "true";
                })
                .catch(err => console.error("Erro ao carregar gr√°fico:", err));
        }

        // Carregar o gr√°fico da primeira aba (ativa) automaticamente ao abrir a p√°gina
        document.addEventListener("DOMContentLoaded", function() {
            // Pega o bot√£o da aba ativa e dispara o clique simulado ou chama a fun√ß√£o direto
            const activeTab = document.querySelector('.nav-link.active');
            if(activeTab) {
                // Extrai os parametros do onclick
                // Ex: onclick="carregarGrafico('1', '5', '08-2025')"
                const onclickText = activeTab.getAttribute('onclick');
                // Pequeno hack para executar a fun√ß√£o extraindo os argumentos
                // O ideal √© chamar a fun√ß√£o diretamente se voc√™ tiver os dados, 
                // mas como est√£o no loop do jinja, simular o click funciona bem.
                activeTab.click();
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>